require 'dotenv/load'
require 'airtable'
require 'active_support/all'
require 'yaml'
require 'fileutils'

airtable = Airtable::Client.new(ENV['AIRTABLE_ACCESS_TOKEN'])
tables = ["Pages", "Posts"]

tables.each do |table_name|
  table = airtable.table(ENV['AIRTABLE_BASE_ID'], table_name)
  records = table.records

  unless records.empty?
    File.open("_data/#{table_name.downcase}.yml", 'w') do |file|
      data = records.map(&:attributes)
      warning = "# Do not edit this file manually \n"

      file.write(warning, data.to_yaml)
    end
    # Create files in _pages collection for "Pages" table
    if table_name == "Pages"
      records.each do |record|
        page_name = record['name'].parameterize
        page_title = record['name']
        file_path = "_pages/#{page_name}.md"

        content = <<-HEREDOC
---
layout: page
title: "#{page_title}"
---

{% assign page = site.data.pages | where: "name", "#{page_title}" | first %}
{{ page.body | markdownify }}
        HEREDOC

        FileUtils.mkdir_p(File.dirname(file_path))
        File.open(file_path, 'w') { |file| file.write(content) }
      end
    end
  else
    puts "Skipping #{table_name} as it came back with no records..."
  end
end
